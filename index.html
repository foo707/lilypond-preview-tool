<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LilyPondæ¥½è­œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .editor-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 900px) {
            .editor-section {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .panel h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        textarea {
            width: 100%;
            height: 400px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .preview-area {
            min-height: 500px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .preview-area.loading {
            background: #f8f9fa;
        }
        
        .preview-area img,
        .preview-area embed {
            max-width: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .midi-player {
            width: 100%;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        audio {
            width: 100%;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f8f9fa;
            border-color: #764ba2;
        }
        
        .upload-area input {
            display: none;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .template-btn {
            padding: 8px 16px;
            background: #e9ecef;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .template-btn:hover {
            background: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸº LilyPondæ¥½è­œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</h1>
        <p class="subtitle">é‡‘ç®¡ç·¨æ›²ã®ãŸã‚ã®æ¥½è­œä½œæˆãƒ»å¤‰æ›ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('preview')">
                ğŸ“ LilyPondæ¥½è­œä½œæˆ
            </button>
            <button class="tab" onclick="switchTab('convert')">
                ğŸ”„ MusicXMLå¤‰æ›
            </button>
        </div>
        
        <!-- LilyPondãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
        <div id="preview-tab" class="tab-content active">
            <div class="panel">
                <h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
                <div class="template-buttons">
                    <button class="template-btn" onclick="loadTemplate('trombone3')">ãƒˆãƒ­ãƒ³ãƒœãƒ¼ãƒ³ä¸‰é‡å¥</button>
                    <button class="template-btn" onclick="loadTemplate('brass5')">é‡‘ç®¡äº”é‡å¥</button>
                    <button class="template-btn" onclick="loadTemplate('simple')">ã‚·ãƒ³ãƒ—ãƒ«</button>
                </div>
            </div>
            
            <div class="editor-section">
                <div class="panel">
                    <h3>LilyPondã‚³ãƒ¼ãƒ‰</h3>
                    <textarea id="lilypond-code" placeholder="LilyPondã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
\version "2.24.0"

\header {
  title = "ã‚µãƒ³ãƒ—ãƒ«æ¥½è­œ"
  composer = "ä½œæ›²è€…å"
}

global = {
  \key c \major
  \time 4/4
  \tempo "Andante" 4=72
}

trbOne = \relative c' {
  \clef treble
  c4 d e f |
  g2 g |
  a4 g f e |
  d2 c |
}

trbTwo = \relative c {
  \clef bass
  e4 f g a |
  b2 b |
  c4 b a g |
  f2 e |
}

trbThree = \relative c {
  \clef bass
  c4 d e f |
  g2 g |
  f4 e d c |
  b2 c |
}

\score {
  \new StaffGroup <<
    \new Staff \with { instrumentName = "Trb 1" } {
      \global
      \trbOne
    }
    \new Staff \with { instrumentName = "Trb 2" } {
      \global
      \trbTwo
    }
    \new Staff \with { instrumentName = "Trb 3" } {
      \global
      \trbThree
    }
  >>
  \layout { }
  \midi { }
}
                    </textarea>
                    <div class="button-group">
                        <button class="btn-primary" onclick="renderLilypond()">
                            ğŸµ æ¥½è­œã«ã™ã‚‹
                        </button>
                        <button class="btn-secondary" onclick="clearCode()">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div id="preview" class="preview-area">
                        <p style="color: #999;">æ¥½è­œãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                    <div id="midi-container"></div>
                </div>
            </div>
            
            <div id="message-area"></div>
        </div>
        
        <!-- MusicXMLå¤‰æ›ã‚¿ãƒ– -->
        <div id="convert-tab" class="tab-content">
            <div class="panel">
                <h3>MusicXML â†’ LilyPondå¤‰æ›</h3>
                <div class="upload-area" onclick="document.getElementById('xml-file').click()">
                    <div class="upload-icon">ğŸ“</div>
                    <p><strong>MusicXMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong></p>
                    <p>ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        å¯¾å¿œå½¢å¼: .xml, .musicxml, .mxl
                    </p>
                    <input type="file" id="xml-file" accept=".xml,.musicxml,.mxl" onchange="convertMusicXML(event)">
                </div>
            </div>
            
            <div class="editor-section" style="margin-top: 20px;">
                <div class="panel">
                    <h3>å¤‰æ›çµæœï¼ˆLilyPondï¼‰</h3>
                    <textarea id="converted-code" placeholder="å¤‰æ›ã•ã‚ŒãŸLilyPondã‚³ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™..." readonly></textarea>
                    <div class="button-group">
                        <button class="btn-success" onclick="copyToEditor()">
                            âœ¨ ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ”ãƒ¼
                        </button>
                        <button class="btn-primary" onclick="renderConverted()">
                            ğŸµ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div id="convert-preview" class="preview-area">
                        <p style="color: #999;">å¤‰æ›å¾Œã®æ¥½è­œãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>
            </div>
            
            <div id="convert-message-area"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        function loadTemplate(type) {
            const templates = {
                'trombone3': `\\version "2.24.0"

\\header {
  title = "ãƒˆãƒ­ãƒ³ãƒœãƒ¼ãƒ³ä¸‰é‡å¥"
  composer = ""
}

global = {
  \\key c \\minor
  \\time 4/4
  \\tempo "Andante" 4=72
}

trbOne = \\relative c' {
  \\clef tenor
  c4 d es f |
  g2 g |
}

trbTwo = \\relative c {
  \\clef bass
  es4 f g aes |
  bes2 bes |
}

trbThree = \\relative c {
  \\clef bass
  c4 d es f |
  g2 g |
}

\\score {
  \\new StaffGroup <<
    \\new Staff \\with { instrumentName = "Trb 1" } {
      \\global
      \\trbOne
    }
    \\new Staff \\with { instrumentName = "Trb 2" } {
      \\global
      \\trbTwo
    }
    \\new Staff \\with { instrumentName = "Trb 3" } {
      \\global
      \\trbThree
    }
  >>
  \\layout { }
  \\midi { }
}`,
                'brass5': `\\version "2.24.0"

\\header {
  title = "é‡‘ç®¡äº”é‡å¥"
}

global = {
  \\key c \\major
  \\time 4/4
}

trumpet = \\relative c'' {
  \\clef treble
  c4 d e f |
}

horn = \\relative c' {
  \\clef treble
  e4 f g a |
}

trombone = \\relative c {
  \\clef bass
  c4 d e f |
}

tuba = \\relative c {
  \\clef bass
  c4 b a g |
}

\\score {
  \\new StaffGroup <<
    \\new Staff \\with { instrumentName = "Tp" } { \\global \\trumpet }
    \\new Staff \\with { instrumentName = "Hr" } { \\global \\horn }
    \\new Staff \\with { instrumentName = "Trb" } { \\global \\trombone }
    \\new Staff \\with { instrumentName = "Tuba" } { \\global \\tuba }
  >>
  \\layout { }
  \\midi { }
}`,
                'simple': `\\version "2.24.0"

{
  c' d' e' f' g'2
}`
            };
            
            document.getElementById('lilypond-code').value = templates[type];
        }
        
        // LilyPondãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        async function renderLilypond() {
            const code = document.getElementById('lilypond-code').value;
            const preview = document.getElementById('preview');
            const messageArea = document.getElementById('message-area');
            
            if (!code.trim()) {
                showMessage(messageArea, 'LilyPondã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            preview.innerHTML = '<div class="loading-spinner"></div><p style="margin-top: 20px;">æ¥½è­œã‚’ç”Ÿæˆä¸­...</p>';
            preview.classList.add('loading');
            messageArea.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/render`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, format: 'pdf' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // PDFè¡¨ç¤º
                    if (data.pdf) {
                        const pdfBlob = base64ToBlob(data.pdf, 'application/pdf');
                        const pdfUrl = URL.createObjectURL(pdfBlob);
                        preview.innerHTML = `<embed src="${pdfUrl}" type="application/pdf" width="100%" height="600px">`;
                    }
                    
                    // MIDIå†ç”Ÿ
                    if (data.midi) {
                        const midiBlob = base64ToBlob(data.midi, 'audio/midi');
                        const midiUrl = URL.createObjectURL(midiBlob);
                        document.getElementById('midi-container').innerHTML = `
                            <div class="midi-player">
                                <h4>ğŸ¹ MIDIå†ç”Ÿ</h4>
                                <audio controls src="${midiUrl}"></audio>
                            </div>
                        `;
                    }
                    
                    showMessage(messageArea, 'æ¥½è­œã®ç”Ÿæˆã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                } else {
                    preview.innerHTML = '<p style="color: #999;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                    showMessage(messageArea, 'ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
                
                preview.classList.remove('loading');
                
            } catch (error) {
                preview.innerHTML = '<p style="color: #999;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                preview.classList.remove('loading');
                showMessage(messageArea, 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // MusicXMLå¤‰æ›
        async function convertMusicXML(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const messageArea = document.getElementById('convert-message-area');
            messageArea.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_URL}/convert/xml2ly`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('converted-code').value = data.lilypond_code;
                    showMessage(messageArea, 'å¤‰æ›ã«æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                } else {
                    showMessage(messageArea, 'ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
                
            } catch (error) {
                showMessage(messageArea, 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // å¤‰æ›çµæœã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        async function renderConverted() {
            const code = document.getElementById('converted-code').value;
            if (!code) {
                alert('å¤‰æ›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const preview = document.getElementById('convert-preview');
            const messageArea = document.getElementById('convert-message-area');
            
            preview.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}/render`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, format: 'pdf' })
                });
                
                const data = await response.json();
                
                if (data.success && data.pdf) {
                    const pdfBlob = base64ToBlob(data.pdf, 'application/pdf');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    preview.innerHTML = `<embed src="${pdfUrl}" type="application/pdf" width="100%" height="600px">`;
                    showMessage(messageArea, 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†ï¼', 'success');
                } else {
                    preview.innerHTML = '<p style="color: #999;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                    showMessage(messageArea, 'ã‚¨ãƒ©ãƒ¼: ' + data.error, 'error');
                }
                
            } catch (error) {
                preview.innerHTML = '<p style="color: #999;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
                showMessage(messageArea, 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ”ãƒ¼
        function copyToEditor() {
            const convertedCode = document.getElementById('converted-code').value;
            document.getElementById('lilypond-code').value = convertedCode;
            switchTab('preview');
            alert('ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }
        
        // ã‚³ãƒ¼ãƒ‰ã‚¯ãƒªã‚¢
        function clearCode() {
            if (confirm('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById('lilypond-code').value = '';
                document.getElementById('preview').innerHTML = '<p style="color: #999;">æ¥½è­œãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                document.getElementById('midi-container').innerHTML = '';
                document.getElementById('message-area').innerHTML = '';
            }
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function base64ToBlob(base64, type) {
            const binary = atob(base64);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type });
        }
        
        function showMessage(container, message, type) {
            container.innerHTML = `<div class="${type}">${message}</div>`;
        }
    </script>
</body>
</html>
